Private Sub importer_Click()
    Dim dossier As String
    Dim listeFichiers As Collection
    Dim fichier As Variant
    Dim tabFinal() As Variant
    Dim i As Long
    
    ' Choisir un dossier
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Sélectionnez le dossier contenant les fichiers Excel"
        If .Show <> -1 Then Exit Sub
        dossier = .SelectedItems(1)
    End With

    ' Liste des fichiers Excel
    Set listeFichiers = New Collection
    Call ParcourirDossier(dossier, listeFichiers)

    ' Préparer tableau résultat à 3 colonnes
    ReDim tabFinal(1 To listeFichiers.Count, 1 To 3)

    i = 1
    Dim chemin As String
    Dim elements() As String
    Dim produit As String
    Dim reseau_dist As String
    Dim nomFichier As String

    For Each fichier In listeFichiers
        chemin = fichier
        elements = Split(chemin, "\")
        
        nomFichier = elements(UBound(elements)) ' nom du fichier
        produit = elements(UBound(elements) - 1) ' nom du dossier qui contient le fichier
        reseau_dist = elements(UBound(elements) - 2) ' dossier au-dessus (grand-parent)

        tabFinal(i, 1) = reseau_dist
        tabFinal(i, 2) = produit
        tabFinal(i, 3) = nomFichier
        i = i + 1
    Next

    ' (Optionnel) Afficher dans une nouvelle feuille Excel
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets.Add
    ws.Name = "Fichiers importés"

    ws.Cells(1, 1).Value = "Réseau_dist"
    ws.Cells(1, 2).Value = "Produit"
    ws.Cells(1, 3).Value = "Fichier"

    ws.Range("A2").Resize(UBound(tabFinal), 3).Value = tabFinal

    MsgBox listeFichiers.Count & " fichiers traités et listés avec succès.", vbInformation
End Sub


Private Sub ParcourirDossier(ByVal chemin As String, ByRef fichiers As Collection)
    Dim fso As Object, dossier As Object, sousDossier As Object, fichier As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set dossier = fso.GetFolder(chemin)

    For Each fichier In dossier.Files
        If LCase(fso.GetExtensionName(fichier.Name)) = "xlsx" Then
            fichiers.Add fichier.Path
        End If
    Next

    For Each sousDossier In dossier.SubFolders
        Call ParcourirDossier(sousDossier.Path, fichiers)
    Next
End Sub
